<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Galaxy Social Post Creator</title>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-3xl mx-auto p-6 bg-white shadow-xl mt-10 rounded-xl">
    <h1 class="text-2xl font-bold mb-6">Galaxy Social Post Creator</h1>

    <form id="post-form" class="space-y-6">
      <div>
        <label class="block font-medium">Title</label>
        <input type="text" id="post-title" class="w-full p-2 border rounded" required />
      </div>

      <div>
        <label class="block font-medium">Content</label>
        <textarea id="post-content" class="w-full p-2 border rounded h-40" required></textarea>
      </div>

      <div>
        <label class="block font-medium mb-2">Select Media Platforms</label>
        <div id="media-options" class="flex flex-col gap-4"></div>
      </div>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Generate Markdown File
      </button>
    </form>

    <div id="output-container" class="mt-8 hidden">
      <h2 class="text-xl font-semibold mb-2">Generated Markdown Content</h2>
      <pre id="output" class="bg-gray-100 p-4 rounded overflow-auto whitespace-pre-wrap"></pre>
      <a id="download-link" download="new-post.md" class="inline-block mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Download .md File</a>
    </div>
  </div>

  <script>
    async function loadMediaOptions() {
      try {
        const response = await fetch('https://raw.githubusercontent.com/usegalaxy-eu/galaxy-social/main/plugins.yml');
        const yamlText = await response.text();
        const data = jsyaml.load(yamlText);
        const plugins = data.plugins;

        const container = document.getElementById('media-options');
        container.innerHTML = '';

        plugins.forEach(plugin => {
          if (plugin.enabled) {
            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-2';

            const checkboxLabel = document.createElement('label');
            checkboxLabel.className = 'flex items-center space-x-2';
            checkboxLabel.innerHTML = `<input type="checkbox" value="${plugin.name}" class="form-checkbox media-checkbox"> <span class="font-semibold">${plugin.name}</span>`;
            wrapper.appendChild(checkboxLabel);

            const mentionsInput = document.createElement('input');
            mentionsInput.placeholder = 'Mentions (comma-separated)';
            mentionsInput.className = 'mention-input hidden w-full p-2 border rounded';

            const hashtagsInput = document.createElement('input');
            hashtagsInput.placeholder = 'Hashtags (comma-separated)';
            hashtagsInput.className = 'hashtag-input hidden w-full p-2 border rounded';

            wrapper.appendChild(mentionsInput);
            wrapper.appendChild(hashtagsInput);
            container.appendChild(wrapper);
          }
        });

        // Add event listeners
        document.querySelectorAll('.media-checkbox').forEach((checkbox, index) => {
          checkbox.addEventListener('change', (e) => {
            const parent = e.target.closest('div');
            const mentions = parent.querySelector('.mention-input');
            const hashtags = parent.querySelector('.hashtag-input');
            if (e.target.checked) {
              mentions.classList.remove('hidden');
              hashtags.classList.remove('hidden');
            } else {
              mentions.classList.add('hidden');
              hashtags.classList.add('hidden');
            }
          });
        });
      } catch (error) {
        console.error('Error loading media list:', error);
      }
    }

    document.getElementById('post-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const title = document.getElementById('post-title').value;
      const content = document.getElementById('post-content').value;
      const mediaElems = document.querySelectorAll('.media-checkbox');
      const selectedMedia = [];
      const mentions = {};
      const hashtags = {};

      mediaElems.forEach(checkbox => {
        if (checkbox.checked) {
          const media = checkbox.value;
          selectedMedia.push(media);
          const parent = checkbox.closest('div');
          const mentionVal = parent.querySelector('.mention-input').value.trim();
          const hashtagVal = parent.querySelector('.hashtag-input').value.trim();

          if (mentionVal) {
            mentions[media] = mentionVal.split(',').map(s => s.trim());
          }
          if (hashtagVal) {
            hashtags[media] = hashtagVal.split(',').map(s => s.trim());
          }
        }
      });

      let metadata = `---\nmedia:\n${selectedMedia.map(m => ` - ${m}`).join('\n')}`;
      if (Object.keys(mentions).length > 0) {
        metadata += `\nmentions:`;
        for (let key in mentions) {
          metadata += `\n ${key}:\n  - ${mentions[key].join("\n  - ")}`;
        }
      }
      if (Object.keys(hashtags).length > 0) {
        metadata += `\nhashtags:`;
        for (let key in hashtags) {
          metadata += `\n ${key}:\n  - ${hashtags[key].join("\n  - ")}`;
        }
      }
      metadata += `\n---\n`;

      const fullContent = `${metadata}\n${content.trim()}\n`;

      const output = document.getElementById('output');
      output.textContent = fullContent;

      const blob = new Blob([fullContent], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const link = document.getElementById('download-link');
      link.href = url;

      document.getElementById('output-container').classList.remove('hidden');
    });

    loadMediaOptions();
  </script>
</body>
</html>
