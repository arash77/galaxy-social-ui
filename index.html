<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Galaxy Social Post Creator</title>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-3xl mx-auto p-6 bg-white shadow-xl mt-10 rounded-xl">
    <h1 class="text-2xl font-bold mb-6">Galaxy Social Post Creator</h1>
    <div id="error-message" class="text-red-500 mb-4 hidden"></div>
    <form id="post-form" class="space-y-6">
      <div>
        <label class="block font-medium">Title (used as filename)</label>
        <input type="text" id="post-title" class="w-full p-2 border rounded" required />
      </div>
      <div>
        <label class="block font-medium">Content</label>
        <textarea id="post-content"></textarea>
      </div>
      <div>
        <label class="block font-medium mb-2">Select Media Platforms</label>
        <div id="media-options" class="flex flex-col gap-4"></div>
      </div>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Generate Markdown File
      </button>
    </form>
    <div id="output-container" class="mt-8 hidden">
      <h2 class="text-xl font-semibold mb-2">Generated Markdown Content</h2>
      <pre id="output" class="bg-gray-100 p-4 rounded overflow-auto whitespace-pre-wrap"></pre>
      <a id="download-link" class="inline-block mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Download .md File</a>
    </div>
  </div>
  <script>
    let easyMDE;
    const tagInstances = {};
    const errorDiv = document.getElementById('error-message');

    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.classList.remove('hidden');
    }
    function clearError() {
      errorDiv.textContent = '';
      errorDiv.classList.add('hidden');
    }

    window.addEventListener('DOMContentLoaded', async () => {
      easyMDE = new EasyMDE({ element: document.getElementById('post-content') });
      try {
        const res = await fetch('https://raw.githubusercontent.com/usegalaxy-eu/galaxy-social/main/plugins.yml');
        if (!res.ok) throw new Error('YAML fetch failed');
        const data = jsyaml.load(await res.text());
        const container = document.getElementById('media-options');
        data.plugins.filter(p => p.enabled).forEach(plugin => {
          const name = plugin.name;
          const wrap = document.createElement('div'); wrap.id = `wrap-${name}`; wrap.className = 'space-y-2';
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = `cb-${name}`; cb.value = name; cb.className = 'form-checkbox';
          const lbl = document.createElement('label'); lbl.htmlFor = cb.id; lbl.className = 'flex items-center space-x-2'; lbl.appendChild(cb);
          const spanLabel = document.createElement('span'); spanLabel.className = 'font-semibold'; spanLabel.textContent = name;
          lbl.appendChild(spanLabel); wrap.appendChild(lbl);
          const tagContainer = document.createElement('div'); tagContainer.id = `tags-${name}`; tagContainer.className = 'space-y-2 hidden';
          const mIn = document.createElement('input'); mIn.id = `mention-${name}`; mIn.placeholder = 'Mentions (no spaces)'; mIn.className = 'w-full p-2 border rounded';
          const hIn = document.createElement('input'); hIn.id = `hashtag-${name}`; hIn.placeholder = 'Hashtags (no spaces)'; hIn.className = 'w-full p-2 border rounded';
          tagContainer.appendChild(mIn); tagContainer.appendChild(hIn); wrap.appendChild(tagContainer); container.appendChild(wrap);
          tagInstances[`mention-${name}`] = new Tagify(mIn, { pattern: /^[^\s]+$/ });
          tagInstances[`hashtag-${name}`] = new Tagify(hIn, { pattern: /^[^\s]+$/ });
          cb.addEventListener('change', () => tagContainer.classList.toggle('hidden', !cb.checked));
        });
      } catch (e) { console.error(e); showError('Failed to load media options'); }

      document.getElementById('post-form').addEventListener('submit', e => {
        e.preventDefault(); clearError();
        const title = document.getElementById('post-title').value.trim();
        const content = easyMDE.value().trim();
        if (!title) return showError('Title is required');
        if (!content) return showError('Content cannot be empty');
        const selected = Array.from(document.querySelectorAll('input[type=checkbox].form-checkbox'))
          .filter(cb => cb.checked).map(cb => cb.value);
        if (selected.length === 0) return showError('Select at least one media');
        const mentions = {}, hashtags = {};
        for (const name of selected) {
          const mTags = tagInstances[`mention-${name}`].value;
          const hTags = tagInstances[`hashtag-${name}`].value;
          if (mTags.length) mentions[name] = mTags.map(t=>t.value);
          if (hTags.length) hashtags[name] = hTags.map(t=>t.value);
        }
        const slug = title.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
        const filename = `${slug}.md`;
        let meta = `---\nmedia:\n${selected.map(m=>` - ${m}`).join('\n')}`;
        if (Object.keys(mentions).length) meta += `\nmentions:` + Object.entries(mentions)
          .map(([k,vs])=>`\n ${k}:\n${vs.map(v=>`  - ${v}`).join('\n')}`).join('');
        if (Object.keys(hashtags).length) meta += `\nhashtags:` + Object.entries(hashtags)
          .map(([k,vs])=>`\n ${k}:\n${vs.map(v=>`  - ${v}`).join('\n')}`).join('');
        meta += `\n---`;
        const full = `${meta}\n${content}\n`;
        document.getElementById('output').textContent = full;
        const link = document.getElementById('download-link');
        link.href = URL.createObjectURL(new Blob([full],{type:'text/markdown'}));
        link.download = filename;
        document.getElementById('output-container').classList.remove('hidden');
      });
    });
  </script>
</body>
</html>
